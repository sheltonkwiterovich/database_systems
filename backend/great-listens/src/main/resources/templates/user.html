<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link rel="stylesheet" href="css/styles4.css">
</head>
<body>
    <div class="navigation">
        <button onclick="window.location.href='/dashboard2'">Back</button>
        <button class="delete-account" onclick="logout()">Logout</button>
    </div>
    <header>
        <h1>Hey Great Listensâ€™s User!<br>Welcome to your Profile</h1>
    </header>

    <section class="user-info">
        <div class="about-you">
            <h2>About You:</h2>
            <form id="userForm">
                <input type="text" id="firstName" placeholder="Your First Name">
                <input type="text" id="lastName" placeholder="Your Last Name">
                <input type="text" id="dob" placeholder="Your DOB">
                <input type="tel" id="phoneNumber" placeholder="Your Phone Number">
                <input type="email" id="email" placeholder="Your Email">
            </form>
        </div>

        <div class="past-reads">
            <h2>Past Reads:</h2>
            <!-- Dynamically populated list of past-read books -->
        </div>
    </section>
    
    <script>
        function fetchUserData() {
            const token = sessionStorage.getItem('authToken');
            if (!token) {
                // Redirect to login page if no token is found
                window.location.href = '/login1.html';
                return;
            }

            fetch('http://localhost:8080/api/member/view', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token // Include the JWT in the Authorization header
                }
            })
            .then(response => {
                if (!response.ok) {
                    // If the response is not ok, throw an error to be caught by the catch block
                    throw new Error('Network response was not ok: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                // Assuming your backend sends the user data as a JSON object with these properties
                document.getElementById('firstName').value = data.name || '';
                document.getElementById('lastName').value = data.name || '';
                document.getElementById('dob').value = data.date_of_birth || '';
                document.getElementById('phoneNumber').value = data.phone_num || '';
                document.getElementById('email').value = data.email || '';
                fetchUserBooks(token); // Fetch the books after the user data is loaded
            })
            .catch(error => {
                console.error('Error fetching user data:', error);
                // If there's an error (like invalid token), redirect to the login page
                window.location.href = '/login1';
            });
        }

        function fetchUserBooks(token) {
            fetch('http://localhost:8080/api/buy', { // Use the correct API endpoint to get the books purchased by the user
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(books => {
                const pastReadsContainer = document.querySelector('.past-reads');
                // Clear the previous list
                pastReadsContainer.innerHTML = '<h2>Past Reads:</h2>';
                books.forEach(book => {
                    const bookElement = document.createElement('div');
                    bookElement.classList.add('book');
                    bookElement.innerHTML = `
                        <span>ðŸ“˜ ${book.title} - <span class="rating">${book.rating || 'No rating yet'}</span></span>
                        <button onclick="rateBook(${book.id})">Click to rate or edit rating</button>
                    `;
                    pastReadsContainer.appendChild(bookElement);
                });
            })
            .catch(error => {
                console.error('Error fetching books:', error);
            });
        }

        function rateBook(bookId) {
            // Store the bookId in sessionStorage so it can be accessed on the rating page
            sessionStorage.setItem('bookId', bookId);
            window.location.href = '/rate';
        }

        function logout() {
            // ... existing logout function ...
        }

        // Call fetchUserData on page load
        window.addEventListener('load', fetchUserData);
    </script>
      
</body>
</html>