<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link rel="stylesheet" href="css/styles4.css">
</head>
<body>
    <div class="navigation">
        <button onclick="window.location.href='/dashboard2'">Browse Audiobooks</button>
        <button class="delete-account" onclick="logout()">Logout</button>
    </div>
    <header>
        <h1>Hey Great Listensâ€™s User!<br>Welcome to your Profile</h1>
    </header>

    <section class="user-info">
        <div class="about-you">
            <h2>About You:</h2>
            <form id="userForm">
                <input type="text" id="firstName" placeholder="Your First Name">
                <input type="text" id="lastName" placeholder="Your Last Name">
                <input type="text" id="dob" placeholder="Your DOB">
                <input type="tel" id="phoneNumber" placeholder="Your Phone Number">
                <input type="email" id="email" placeholder="Your Email">
            </form>
        </div>

        <div class="past-reads">
            <h2>Past Reads:</h2>
            <!-- Dynamically populated list of past-read books -->
        </div>
    </section>
    
    <script>
        function fetchUserData() {
            const token = sessionStorage.getItem('authToken');
            if (!token) {
                // Redirect to login page if no token is found
                window.location.href = '/login1.html';
                return;
            }

            fetch('http://localhost:8080/api/member/view', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token // Include the JWT in the Authorization header
                }
            })
            .then(response => {
                if (!response.ok) {
                    // If the response is not ok, throw an error to be caught by the catch block
                    throw new Error('Network response was not ok: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                // Assuming your backend sends the user data as a JSON object with these properties
                fetchUserBooks();
                document.getElementById('firstName').value = data.name || '';
                document.getElementById('lastName').value = data.name || '';
                document.getElementById('dob').value = data.date_of_birth || '';
                document.getElementById('phoneNumber').value = data.phone_num || '';
                document.getElementById('email').value = data.email || '';
                fetchUserBooks(token); // Fetch the books after the user data is loaded
            })
            .catch(error => {
                console.error('Error fetching user data:', error);
                // If there's an error (like invalid token), redirect to the login page
                window.location.href = '/login1';
            });
        }

        function fetchUserBooks() {
    const token = sessionStorage.getItem('authToken');
    const mem_id = sessionStorage.getItem('mem_id');

    console.log('fetchUserBooks called'); // Debug statement

    if (!token || !mem_id) {
        console.error('Token or member ID missing in session storage.');
        return;
    }

    console.log(`Attempting to fetch books with mem_id: ${mem_id}`); // Debug statement

    fetch(`http://localhost:8080/api/member/booksBought?mem_id=${encodeURIComponent(mem_id)}`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        console.log('Response received'); // Debug statement
        if (!response.ok) {
            console.error('Response not OK, status:', response.status);
            throw new Error('Network response was not ok: ' + response.statusText);
        }
        return response.json();
    })
    .then(books => {
        console.log('Books received:', books); // Debug statement

        const pastReadsContainer = document.querySelector('.past-reads');
        pastReadsContainer.innerHTML = '<h2>Past Reads:</h2>'; // Reset the inner HTML

        if (Array.isArray(books) && books.length > 0) {
            books.forEach(book => {
                const bookElement = document.createElement('div');
    bookElement.classList.add('book');
    bookElement.setAttribute('data-book-id', book.book_id); 
    bookElement.innerHTML = `
        <h3>${book.book_name}</h3>
        <p>Author: ${book.book_author}</p>
        <p>Narrator: ${book.book_narrator}</p>
        <p>Categories: ${book.categories}</p>
        <p>Rating: ${book.rating}</p>
        <p>Price: $${book.price.toFixed(2)}</p>
        <p>Listening Time: ${book.listening_time} minutes</p>
        <select onchange="updatePersonalRating(this.value, ${book.book_id})">
            <option value="">Select your rating</option>
            <option value="1">1 - Bad</option>
            <option value="2">2 - Meh</option>
            <option value="3">3 - Fine</option>
            <option value="4">4 - Liked</option>
            <option value="5">5 - Loved</option>
        </select>
        <div class="personal-rating"></div>
    `;
                pastReadsContainer.appendChild(bookElement);
            });
        } else {
            console.log('No books or non-array data received'); // Debug statement
        }
    })
    .catch(error => {
        console.error('Error fetching past reads:', error); // Debug statement
    });
}

function updatePersonalRating(rating, bookId) {
    if (!rating) return; // Don't do anything if the rating is not selected
    const ratingElement = document.querySelector(`.book[data-book-id="${bookId}"] .personal-rating`);

    if (ratingElement) {
        ratingElement.innerHTML = `<span style="color: red;">Your Rating: ${rating}</span>`;
    } else {
        console.error('No personal rating element found for bookId:', bookId);
    }
    const token = sessionStorage.getItem('authToken');
    const memId = sessionStorage.getItem('mem_id');
    const payload = {
        mem_id: memId,
        book_id: parseInt(bookId),
        rate: parseInt(rating)
    };

    fetch('http://localhost:8080/api/ratings/create', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': token 
    },
    body: JSON.stringify(payload) // Assuming payload is correctly structured
})

.then(response => {
        console.log('Received response:', response); // Log the raw response object
        const contentType = response.headers.get("content-type");
        if (!response.ok) {
            if (contentType && contentType.includes("application/json")) {
                return response.json().then(data => Promise.reject(data));
            } else {
                return response.text().then(text => Promise.reject(text));
            }
        }
        return contentType && contentType.includes("application/json") ? response.json() : response.text();
    })
    .then(data => {
        console.log('Rating submitted successfully:', data); // Log successful data or text response
       

        
    })
    .catch(error => {
        // Handle any other errors
        console.error('Error updating personal rating:', error);
    });
}
        function logout() {
    if (confirm('Are you sure you want to log out?')) {
        const token = sessionStorage.getItem('authToken');

        if (token) {
            fetch('http://localhost:8080/api/member/logout', {
                method: 'POST', // Logout might be implemented as a POST request
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => {
                if (response.ok) {
                    alert('You have been logged out.');
                } else {
                    console.error('Failed to invalidate token on the server');
                }
            })
            .catch(error => {
                console.error('Error during logout:', error);
            });
        }

        // Remove the JWT from sessionStorage regardless of whether the server invalidation was successful
        sessionStorage.removeItem('authToken');
        // Redirect to the home page or login page
        window.location.href = '/';
    }
}

        // Call fetchUserData on page load
        window.addEventListener('load', fetchUserData);
    </script>
      
</body>
</html>