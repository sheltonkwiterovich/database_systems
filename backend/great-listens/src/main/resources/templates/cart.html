<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shopping Cart - Great Listens</title>
    <link rel="stylesheet" href="/css/styles2.css">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="/dashboard2">Shop for AudioBooks</a></li>
                <li><a href="/" class="title">Great Listens</a></li>
                <li><a href="/user">Your Profile</a></li>
            </ul>
        </nav>
    </header>
    <div class="main-container">
        <div class="split left">
            <h2>Your Cart</h2>
            <section class="book-grid" id="book-grid">
                <!-- Books will be loaded here by JavaScript -->
            </section>
            <div id="cart-total"><!-- Total will be loaded here --></div>
        </div>
        
        <div class="split right">
            <h2>Proceed to Checkout</h2>
            <form id="checkout-form">
                <label for="card-number">Card Number:</label>
                <input type="text" id="card-number" name="card-number" required>
                
                <label for="cvv">CVV:</label>
                <input type="text" id="cvv" name="cvv" required>
                
                <label for="expiration-date">Expiration Date:</label>
                <input type="date" id="expiration-date" name="expiration-date" required>
                
                <label for="card-name">Name on Card:</label>
                <input type="text" id="card-name" name="card-name" required>
                
                <button type="submit">COMPLETE PURCHASE</button>
            </form>
        </div>
    </div>
    <script>
        var bookIdsInCart = []; // Store book IDs here

        $(document).ready(function() {
            viewBooksInCart(); // Load books in cart when page loads

            $('#checkout-form').on('submit', function(e) {
                e.preventDefault(); // Prevent the form from submitting the default way
                handleCheckout(); // Call the handleCheckout function
            });
        });

        function viewBooksInCart() {
            var cart_id = sessionStorage.getItem('cart_id'); // Retrieve the cart ID stored in the session
            $.ajax({
                url: 'http://localhost:8080/api/cart/view',
                type: 'GET',
                data: { 'cart_id': cart_id },
                success: function(books) {
                    $('#book-grid').empty(); // Clear existing entries
                    bookIdsInCart = []; // Reset the book IDs array
                    books.forEach(function(book) {
                        bookIdsInCart.push(book.book_id); // Store book ID
                        $('#book-grid').append(
                            '<div class="book-item">' +
                                '<h3>' + book.book_name + '</h3>' +
                                '<p>Author: ' + book.book_author + '</p>' +
                                '<p>Narrator: ' + book.book_narrator + '</p>' +
                                '<button onclick="removeFromCart(' + book.book_id + ')">Remove from Cart</button>' +
                            '</div>'
                        );
                    });
                    updateCartTotal();
                },
                error: function(xhr) {
                    alert('Failed to load books in cart: ' + xhr.responseText);
                }
            });
        }

        function updateCartTotal() {
            var cartId = sessionStorage.getItem('cart_id');
            $.ajax({
                url: 'http://localhost:8080/api/cart/total',
                type: 'GET',
                data: { 'cart_id': cart_id },
                success: function(total) {
                    $('#cart-total').text('Total: $' + total);
                },
                error: function(xhr) {
                    alert('Failed to load cart total: ' + xhr.responseText);
                }
            });
        }

        function removeFromCart(bookId) {
            var cartId = sessionStorage.getItem('cart_id');
            $.ajax({
                url: 'http://localhost:8080/api/cart/removeBook',
                type: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({ 'cart_id': cart_id, 'book_id': bookId }),
                success: function() {
                    alert('Book removed from cart');
                    viewBooksInCart(); // Refresh the cart items
                    updateCartTotal(); // Update the total price displayed
                },
                error: function(xhr) {
                    alert('Failed to remove book from cart: ' + xhr.responseText);
                }
            });
        }

        function handleCheckout() {
            var checkoutData = {
                "cart_id": sessionStorage.getItem('cart_id'), // Ensure this matches what you set during cart creation
                "mem_id": sessionStorage.getItem('mem_id'), // Get the member ID stored in session
                "book_list": bookIdsInCart,
                "card_holder": $('#card-name').val(),
                "credit_card": $('#card-number').val(),
                "card_name": $('#card-name').val(),
                "expiration": $('#expiration-date').val(),
                "csv": $('#cvv').val()
            };

            $.ajax({
                url: 'http://localhost:8080/api/buy',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(checkoutData),
                success: function(response) {
                    alert('Purchase complete! Confirmation code: ' + response.conf_code);
                    // Redirect or update UI as necessary
                },
                error: function(xhr) {
                    alert('Checkout failed: ' + xhr.responseText);
                }
            });
        }
    </script>
</body>
</html>
